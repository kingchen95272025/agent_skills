# 代码复核标准

本文档定义了 Kiro 工作流第五阶段（代码复核）中的评分机制和评估标准。

## 评分机制概述

代码复核采用多维度评估体系，每个维度使用 0-10 分评分，最终计算综合得分。

### 评分维度和权重

| 维度 | 权重 | 说明 |
|------|------|------|
| 需求符合度 | 25% | 检查每个需求是否完全实现，是否存在遗漏或偏差 |
| 设计一致性 | 25% | 验证实现是否遵循设计文档中的架构、接口、数据模型等规范 |
| 代码规范性 | 25% | 检查代码是否符合项目的编码规范、最佳实践 |
| 代码质量 | 25% | 评估代码的可读性、可维护性、性能、安全性等 |

**综合得分计算公式：**

```
综合得分 = 需求符合度 × 0.25 + 设计一致性 × 0.25 + 代码规范性 × 0.25 + 代码质量 × 0.25
```

## 完成标准判断

根据综合得分判断代码质量和后续行动：

| 得分区间 | 质量评级 | 建议行动 |
|---------|---------|---------|
| >= 8.5分 | 优秀 | 可直接完成，无需优化 |
| 6.0-8.4分 | 良好 | 存在改进空间，建议优化 |
| < 6.0分 | 需改进 | 必须进行优化 |

## 维度一：需求符合度 (25%权重)

### 评分标准

| 分数 | 标准 |
|------|------|
| 9-10分 | 所有需求完全实现，无遗漏，无偏差 |
| 7-8分 | 主要需求完全实现，存在1-2个次要需求遗漏或轻微偏差 |
| 5-6分 | 大部分需求实现，存在3-5个需求遗漏或明显偏差 |
| 3-4分 | 部分需求实现，存在多个重要需求遗漏 |
| 0-2分 | 大量需求未实现或严重偏差 |

### 检查要点

**1. 需求完整性检查**
- 逐一对照需求文档中的每个需求点
- 检查每个用户故事是否都有对应的代码实现
- 检查每个验收标准是否都能通过
- 确认没有遗漏任何需求点

**2. 需求实现准确性检查**
- 实现的功能是否符合需求描述
- 业务规则是否正确执行
- 边缘情况是否都考虑到
- 错误处理是否符合需求

**3. 需求追溯性检查**
- 每个实现的功能都能追溯到具体需求
- 没有实现需求外的功能（避免过度开发）
- 需求变更是否都体现在代码中

### 常见问题

- ❌ 遗漏部分需求点
- ❌ 实现的功能与需求描述不一致
- ❌ 忽略了边缘情况和异常处理
- ❌ 验收标准无法通过
- ❌ 包含需求外的功能

## 维度二：设计一致性 (25%权重)

### 评分标准

| 分数 | 标准 |
|------|------|
| 9-10分 | 完全遵循设计文档，架构、接口、数据模型等完全一致 |
| 7-8分 | 基本遵循设计文档，存在1-2处轻微偏差但不影响整体架构 |
| 5-6分 | 部分遵循设计文档，存在3-5处明显偏差 |
| 3-4分 | 较少遵循设计文档，多处实现与设计不一致 |
| 0-2分 | 基本未遵循设计文档，架构混乱 |

### 检查要点

**1. 架构一致性检查**
- 是否遵循设计的分层架构
- Model、Repository、Service、Controller、Resource等层次是否完整
- 各层职责是否清晰，没有越界
- 数据流是否符合设计的流向

**2. 接口一致性检查**
- 方法签名是否与设计文档一致
- 参数和返回值类型是否一致
- 接口命名是否符合设计规范
- 公共方法和私有方法的划分是否合理

**3. 数据模型一致性检查**
- 数据表结构是否与设计一致
- 字段类型、长度、约束是否一致
- 索引设计是否完整
- 关联关系是否正确实现

**4. 业务逻辑一致性检查**
- 服务层逻辑是否严格按照设计的逻辑注释实现
- 业务流程是否符合设计的序列图
- 状态流转是否正确
- 事务边界是否合理

### 常见问题

- ❌ 跳过某些设计的层次（如直接在Controller调用Repository）
- ❌ 方法签名与设计不一致
- ❌ 数据表结构与设计SQL不一致
- ❌ 业务逻辑实现与设计注释偏差较大
- ❌ 未按设计的组件结构组织代码

## 维度三：代码规范性 (25%权重)

### 评分标准

| 分数 | 标准 |
|------|------|
| 9-10分 | 完全符合项目编码规范，无任何规范性问题 |
| 7-8分 | 基本符合规范，存在1-3处轻微不规范 |
| 5-6分 | 部分符合规范，存在4-10处不规范 |
| 3-4分 | 较少符合规范，存在多处明显不规范 |
| 0-2分 | 基本不符合规范，代码风格混乱 |

### 检查要点

**1. 命名规范检查**
- 类名、方法名、变量名是否符合规范
- 命名是否有意义，能体现其作用
- 常量、枚举是否使用大写+下划线
- 数据表名、字段名是否符合规范

**2. 注释规范检查**
- PHPDoc注释是否完整
- 类、方法、属性的注释是否清晰
- 复杂逻辑是否有足够的行内注释
- 注释是否准确反映代码功能

**3. 代码组织规范检查**
- 文件组织是否符合项目结构
- 命名空间是否正确
- 类的职责是否单一
- 方法长度是否合理（不超过50行）

**4. Laravel规范检查**
- 是否正确使用Eloquent特性
- 是否正确使用依赖注入
- 是否正确使用Laravel的辅助函数
- 是否遵循Laravel最佳实践

**5. 无硬编码检查**
- 所有固定值是否都使用枚举
- 配置项是否使用配置文件
- 魔法数字是否都定义为常量
- 字符串是否都使用多语言

### 常见问题

- ❌ 存在硬编码的数值或字符串
- ❌ 缺少必要的注释或注释不准确
- ❌ 命名不规范或无意义
- ❌ 代码组织混乱
- ❌ 未使用Laravel的标准特性

## 维度四：代码质量 (25%权重)

### 评分标准

| 分数 | 标准 |
|------|------|
| 9-10分 | 代码质量优秀，可读性强，性能好，安全性高 |
| 7-8分 | 代码质量良好，存在1-2处可优化点 |
| 5-6分 | 代码质量一般，存在3-5处明显的质量问题 |
| 3-4分 | 代码质量较差，存在多处质量问题 |
| 0-2分 | 代码质量很差，难以维护 |

### 检查要点

**1. 可读性检查**
- 代码逻辑是否清晰易懂
- 是否有复杂的嵌套逻辑需要简化
- 变量、方法命名是否表意清晰
- 代码格式是否整洁统一

**2. 可维护性检查**
- 是否遵循SOLID原则
- 代码耦合度是否低
- 是否易于扩展和修改
- 是否有重复代码需要提取

**3. 性能检查**
- 是否存在N+1查询问题
- 是否正确使用了索引
- 是否有不必要的循环或递归
- 大数据量处理是否优化

**4. 安全性检查**
- 是否有SQL注入风险
- 是否有XSS攻击风险
- 敏感数据是否加密
- 权限校验是否完整

**5. 异常处理检查**
- 是否有完善的异常处理
- 是否使用了合适的异常类型
- 错误信息是否友好且安全
- 是否记录了必要的日志

**6. 多语言支持检查**
- 所有用户可见文本是否支持多语言
- 多语言key是否规范
- 枚举类是否维护了多语言翻译
- 错误消息是否支持多语言

### 常见问题

- ❌ 存在N+1查询问题
- ❌ 代码重复度高
- ❌ 缺少异常处理或异常处理不当
- ❌ 性能瓶颈未优化
- ❌ 存在安全隐患
- ❌ 未支持多语言

## 复核报告格式

代码复核完成后，创建 `.claude/specs/{功能名}/review.md` 文档，包含以下内容：

### 1. 评分总览

```markdown
# 代码复核报告

## 评分总览

| 维度 | 得分 | 权重 | 加权得分 |
|------|------|------|----------|
| 需求符合度 | X.X | 25% | X.XX |
| 设计一致性 | X.X | 25% | X.XX |
| 代码规范性 | X.X | 25% | X.XX |
| 代码质量 | X.X | 25% | X.XX |
| **综合得分** | **X.XX** | 100% | **X.XX** |

**质量评级：** [优秀/良好/需改进]

**建议行动：** [可直接完成/建议优化/必须优化]
```

### 2. 符合度分析

```markdown
## 符合度分析

### 需求符合度分析
- **得分：** X.X/10
- **评估：** [详细描述]
- **已实现需求：** [列表]
- **未实现需求：** [列表]
- **偏差需求：** [列表]

### 设计一致性分析
- **得分：** X.X/10
- **评估：** [详细描述]
- **符合设计部分：** [列表]
- **偏差设计部分：** [列表]

### 代码规范性分析
- **得分：** X.X/10
- **评估：** [详细描述]
- **规范问题统计：** [列表]

### 代码质量分析
- **得分：** X.X/10
- **评估：** [详细描述]
- **质量问题统计：** [列表]
```

### 3. 问题清单

```markdown
## 问题清单

### 严重问题（必须修复）
1. [问题描述]
   - **位置：** [文件:行号]
   - **类型：** [需求/设计/规范/质量]
   - **影响：** [影响说明]
   - **建议：** [修复建议]

### 重要问题（建议修复）
...

### 轻微问题（可选修复）
...
```

### 4. 改进建议

```markdown
## 改进建议

### 需求符合度改进
1. [具体建议]

### 设计一致性改进
1. [具体建议]

### 代码规范性改进
1. [具体建议]

### 代码质量改进
1. [具体建议]
```

### 5. 优化优先级

```markdown
## 优化优先级

### 第一优先级（立即处理）
- [ ] 问题1
- [ ] 问题2

### 第二优先级（本轮处理）
- [ ] 问题3
- [ ] 问题4

### 第三优先级（后续优化）
- [ ] 问题5
- [ ] 问题6
```

## 复核流程

1. **准备阶段**
   - 阅读 requirements.md、design.md、tasks.md
   - 了解项目规范和代码标准
   - 浏览所有实现的代码文件

2. **评估阶段**
   - 按四个维度逐一评估
   - 记录发现的问题
   - 计算各维度得分

3. **报告生成阶段**
   - 填写评分总览
   - 编写符合度分析
   - 整理问题清单
   - 提供改进建议
   - 制定优化优先级

4. **确认阶段**
   - 根据综合得分判断质量等级
   - 向用户说明复核结果
   - 确认是否需要进入优化阶段

## 注意事项

1. **客观评分**：评分必须客观、有依据，不能主观臆断
2. **具体问题**：每个问题都要指出具体位置和具体内容
3. **可操作建议**：改进建议要具体、可操作，不能模糊
4. **完整性**：复核必须覆盖所有代码，不能遗漏
5. **一致性**：评分标准要一致，不能前后矛盾

通过严格的代码复核，确保最终交付的代码质量达到优秀标准。
