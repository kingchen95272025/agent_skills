# 第四阶段：代码实现

## 触发条件

- 任务清单已完成并获得您的认可
- 或您指定要实现某个具体任务

## 我的工作

### 1. 实施前准备

- 调整到 thinkharder 模式
- 必须完全了解项目代码，了解项目规范和具体实现，收集足够完善的上下文，再开始工作
- 在执行任何任务之前，始终确保已阅读`.claude/specs/{功能名}/`下的规格requirements.md、design.md和tasks.md文件
- 在没有需求或设计的情况下执行任务将导致不准确的实现

### 2. 思考过程展示（每个任务必须）

在开始任何任务之前，需要清晰展示：

1. **问题分析** - 这个任务要解决什么问题？
2. **方案选择依据** - 为什么选择这种实现方式？有哪些备选方案？
3. **规范依据** - 参考了哪些规范规则？规范中的具体条款是什么？
4. **参考代码** - 参考了哪些现有代码？为什么参考这些代码？

示例输出格式：

```markdown
任务 2.3 Service 层开发

【思考过程】
- 问题分析：需要实现 xxx 业务逻辑，涉及到 yyy 的处理
- 方案选择依据：参考现有的 ZzzService 实现模式，因为业务场景类似
- 规范依据：根据 `.cursor/rules/service-layer.mdc` 规范，Service 层应该...
- 参考代码：参考 `app/Services/ZzzService.php` 的实现方式

工作内容：创建 XxxService，实现核心业务逻辑

具体步骤：
1. 在 app/Services 目录下创建 XxxService.php
2. 注入 XxxRepository 依赖
3. 实现 xxx 方法
4. 实现 yyy 方法
```

### 3. 代码分层规范复习（重要）

**在每个代码开发任务开始前，必须执行以下规范复习流程：**

#### 3.1 复习流程

对于涉及代码编写的任务，必须：

1. **识别代码分层** - 明确当前任务涉及哪些代码分层（Controller、Service、Repository、Model、Enum 等）
2. **读取对应规范** - 读取 `.cursor/rules` 目录下对应分层的规范文件
3. **读取参考文件** - 如果规范文件中指定了参考文件，**必须重新读取这些参考文件**
4. **展示规范要点** - 向用户展示该分层的核心规范要点
5. **确认遵循** - 在开发过程中严格遵循这些规范

#### 3.2 规范复习输出格式

在开始代码开发任务前，必须输出以下内容：

```markdown
【规范复习】

涉及代码分层：Service 层

已读取规范文件：
- `.cursor/rules/service-layer.mdc`

规范指定的参考文件（已重新读取）：
- `app/Services/ExampleService.php`
- `app/Services/AnotherService.php`

核心规范要点：
1. Service 层负责业务逻辑处理
2. 必须注入 Repository 依赖
3. 方法命名规范：xxx
4. ...

【开始开发】
```

#### 3.3 多分层任务处理

如果一个任务涉及多个代码分层，必须：

- 逐个复习每个分层的规范
- 展示每个分层的核心要点
- 按业务模块的链路顺序开发

#### 3.4 规范冲突处理

如果发现规范之间存在冲突或不明确：

- 暂停开发
- 向用户说明冲突点
- 获得用户确认后继续

### 4. 任务执行策略

- 查看任务清单中的任务详情
- 如果请求的任务有子任务，总是从子任务开始
- **严格一次只专注一个任务** - 不实现其他任务的功能
- 根据任务或其详情中指定的任何需求验证实现
- 任务完成后，需要在`.claude/specs/{功能名}/tasks.md` 文件中将对应的任务标记完成

### 5. 任务推荐

- 如果您指定了具体任务，就实现该任务
- 如果没有指定，我会查看该规格的任务清单并推荐下一个应该执行的任务

### 6. 质量控制

- 完成任务后停下来让您审查
- **不会自动继续到列表中的下一个任务**
- 在任务列表中标记完成状态
- 只有在您要求时才自动运行测试

### 7. 并行操作优化

- 需要执行多个独立操作时，同时调用所有相关工具而非按顺序执行
- 使用'strReplace'工具时，将其分解为独立操作然后同时调用
- 尽可能优先并行调用工具

## 任务问答处理

用户可能会询问任务相关问题而不想执行它们。在这种情况下不要总是开始执行任务。

例如，用户可能想知道特定功能的下一个任务是什么。在这种情况下，只提供信息而不开始任何任务。

## 关键原则

- **一次一个任务** - 完成一个任务后停止，不要自动继续下一个任务
- **用户主导** - 只有用户要求时才继续下一个任务
- **专注执行** - 不实现当前任务范围外的功能
- **持续验证** - 确保实现符合任务要求和设计规范
- **必须展示思考过程** - 展示问题分析、方案选择依据、规范依据、参考代码
- **必须复习代码分层规范** - 代码开发任务开始前必须读取并展示对应分层的规范
- **必须读取参考文件** - 如果规范指定了参考文件，必须重新读取这些参考文件

## 完成标志

所有任务完成并创建completed_tasks.md文件记录完成状态
