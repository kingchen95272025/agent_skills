# 第三阶段：执行 (Execute)

## 触发条件

- 规划阶段完成
- 用户确认实现方案和任务列表
- 准备开始编码实现

## 阶段目标

按照规划的任务列表，高效、高质量地完成所有开发任务。

## 我的工作

### 1. 任务执行流程

对于每个任务，遵循以下流程：

1. 显示任务编号和描述
2. 详细说明要做的工作内容和具体步骤
3. 开始实际的开发工作
4. 完成后更新任务状态
5. 简要说明完成情况
6. 继续下一个任务

### 2. 任务开始前

每个任务开始前，必须说明：

- 任务编号和名称
- **思考过程** - 为什么要这样做，决策依据是什么
- 工作内容
- 具体步骤

**重要：必须展示思考过程和决策依据**

在开始任何任务之前，需要清晰展示：

1. **问题分析** - 这个任务要解决什么问题？
2. **方案选择依据** - 为什么选择这种实现方式？有哪些备选方案？
3. **规范依据** - 参考了哪些规范规则？规范中的具体条款是什么？
4. **参考代码** - 参考了哪些现有代码？为什么参考这些代码？

示例：

```
任务 2.3 Service 层开发

【思考过程】
- 问题分析：需要实现 xxx 业务逻辑，涉及到 yyy 的处理
- 方案选择依据：参考现有的 ZzzService 实现模式，因为业务场景类似
- 规范依据：根据 `.cursor/rules/service-layer.mdc` 规范，Service 层应该...
- 参考代码：参考 `app/Services/ZzzService.php` 的实现方式

工作内容：创建 XxxService，实现核心业务逻辑

具体步骤：
1. 在 app/Services 目录下创建 XxxService.php
2. 注入 XxxRepository 依赖
3. 实现 xxx 方法
4. 实现 yyy 方法
```

### 3. 代码分层规范复习（重要）

**在每个代码开发任务开始前，必须执行以下规范复习流程：**

#### 3.1 复习流程

对于涉及代码编写的任务，必须：

1. **识别代码分层** - 明确当前任务涉及哪些代码分层（Controller、Service、Repository、Model、Enum 等）
2. **读取对应规范** - 读取 `.cursor/rules` 目录下对应分层的规范文件
3. **读取参考文件** - 如果规范文件中指定了参考文件，**必须重新读取这些参考文件**
4. **展示规范要点** - 向用户展示该分层的核心规范要点
5. **确认遵循** - 在开发过程中严格遵循这些规范

#### 3.2 规范复习输出格式

在开始代码开发任务前，必须输出以下内容：

```markdown
【规范复习】

涉及代码分层：Service 层

已读取规范文件：
- `.cursor/rules/service-layer.mdc`

规范指定的参考文件（已重新读取）：
- `app/Services/ExampleService.php`
- `app/Services/AnotherService.php`

核心规范要点：
1. Service 层负责业务逻辑处理
2. 必须注入 Repository 依赖
3. 方法命名规范：xxx
4. ...

【开始开发】
```

#### 3.3 多分层任务处理

如果一个任务涉及多个代码分层，必须：

- 逐个复习每个分层的规范
- 展示每个分层的核心要点
- 按业务模块的链路顺序开发：路由 → 控制器 → 服务层 → 仓储层 → Model层

#### 3.4 规范冲突处理

如果发现规范之间存在冲突或不明确：

- 暂停开发
- 向用户说明冲突点
- 获得用户确认后继续

### 4. 代码实现规范

#### 代码规范

- 严格遵守 `.cursor/rules` 中定义的规范
- 参照规则文件中指定的参考文件
- 保持与现有代码风格一致

#### 开发顺序

按业务模块的核心链路开发：路由 → 控制器 → 服务层 → 仓储层 → Model层

按需补充其他分层：枚举、请求验证、资源转换等

#### 编码要求

- 严禁硬编码，使用枚举替代
- 适配多语言，枚举层维护翻译
- 业务异常码使用数字
- 添加必要的注释说明

### 5. 任务完成后

每个任务完成后，简要说明：

- 完成了什么
- 文件位置
- 然后继续下一个任务

### 6. 进度更新

实时更新 To-dos 状态：

- 使用 TodoWrite 工具更新任务状态
- 当前执行的任务标记为 in_progress
- 完成的任务标记为 completed
- 保持用户对进度的可见性

### 7. 并行执行优化

当多个任务相互独立时：

- 可以同时执行多个工具调用
- 提高执行效率
- 但要确保不会产生冲突

### 8. 简要自查

所有任务完成后，进行简要自查：

- 功能完整性检查
- 规范一致性检查
- 列出创建/修改的文件清单

## 重要约束

- **必须显示任务编号** - 每个任务开始前显示编号
- **必须展示思考过程** - 展示问题分析、方案选择依据、规范依据、参考代码
- **必须复习代码分层规范** - 代码开发任务开始前必须读取并展示对应分层的规范
- **必须读取参考文件** - 如果规范指定了参考文件，必须重新读取这些参考文件
- **必须说明具体步骤** - 不能直接写代码不解释
- **必须实时更新进度** - 让用户了解当前状态
- **必须遵守规范** - 严格按照项目规范编码
- **不自动执行SQL** - SQL 脚本由用户手动执行

## 特殊情况处理

### 遇到问题

如果执行过程中遇到问题：

- 暂停执行，向用户说明情况
- 分析问题原因
- 提出解决方案
- 获得用户确认后继续

### 需求变更

如果用户提出需求变更：

- 暂停当前任务
- 回到规划阶段评估影响
- 更新任务列表
- 获得确认后继续执行

### 任务过大

如果发现某个任务过大：

- 将其拆分为多个子任务
- 更新任务列表
- 先生成框架再补充细节

## 与用户的交互

执行阶段的交互示例：

**任务进行中**：

- "任务 2.3 已完成，继续执行 2.4..."
- "这个任务比较复杂，我分两步来做..."

**遇到问题**：

- "在实现 xxx 时发现一个问题，需要和你确认一下..."
- "这里有两种实现方式，你倾向于哪种？"

**全部完成**：

- "所有任务都完成了，我做了一个简单的自查，你可以验证一下功能..."

## 完成标志

- 所有 To-dos 任务完成
- 简要自查通过
- 向用户汇报完成情况
- 用户确认功能可用
