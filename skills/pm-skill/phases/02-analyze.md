# 第二阶段：分析 (Analyze)

## 触发条件

- 收集阶段完成
- 已获取完整的数据实体信息
- 准备开始深入分析

## 阶段目标

深入分析数据实体关系、业务规则和状态流转，将技术实现转化为业务逻辑理解。

## 我的工作

### 1. 数据维度分析

**核心任务**：识别并分类数据实体的维度

#### 维度分类标准

| 维度类型 | 识别特征 | 业务含义 |
|----------|----------|----------|
| **主实体维度** | 有独立 ID，可独立存在 | 业务核心对象，如订单、用户 |
| **明细维度** | 依附主实体，有外键关联 | 主实体的细节数据，如订单明细 |
| **关联维度** | 连接两个主实体 | 多对多关系的中间表 |
| **日志维度** | 记录时间戳，只增不改 | 历史记录和变更追踪 |
| **配置维度** | 相对静态，被引用 | 系统参数和业务规则配置 |

#### 分析输出格式

```markdown
### 数据维度分析结果

#### 主实体（业务核心对象）

| 实体名称 | 表名 | 业务含义 | 核心字段 |
|----------|------|----------|----------|
| 订单 | orders | 交易的主体记录 | order_no, status, total_amount |
| 用户 | users | 系统用户 | name, phone, email |

#### 明细实体（依附主实体）

| 实体名称 | 表名 | 所属主实体 | 业务含义 |
|----------|------|------------|----------|
| 订单明细 | order_items | 订单 | 订单中的商品明细 |
| 收货地址 | user_addresses | 用户 | 用户的收货地址 |

#### 关联实体（多对多中间表）

| 实体名称 | 表名 | 关联的实体 | 业务含义 |
|----------|------|------------|----------|
| 用户角色 | user_roles | 用户、角色 | 用户与角色的关联 |

#### 日志实体（历史记录）

| 实体名称 | 表名 | 记录对象 | 业务含义 |
|----------|------|----------|----------|
| 订单状态日志 | order_status_logs | 订单 | 记录订单状态变更历史 |

#### 配置实体（系统参数）

| 实体名称 | 表名 | 业务含义 |
|----------|------|----------|
| 运费模板 | shipping_templates | 运费计算规则配置 |
```

### 2. 实体关系分析

**核心任务**：梳理实体间的关联关系

#### 关系类型

| 关系类型 | 代码特征 | 业务含义 |
|----------|----------|----------|
| 一对一 | `hasOne` / `belongsTo` | 一个用户有一个档案 |
| 一对多 | `hasMany` / `belongsTo` | 一个订单有多个明细 |
| 多对多 | `belongsToMany` | 用户可有多个角色，角色可属于多个用户 |

#### 分析输出格式

```markdown
### 实体关系分析结果

#### 关系清单

| 主实体 | 关系 | 从实体 | 业务说明 |
|--------|------|--------|----------|
| 用户 | 1:N | 订单 | 一个用户可以有多个订单 |
| 订单 | 1:N | 订单明细 | 一个订单包含多个商品明细 |
| 订单明细 | N:1 | 商品 | 每个明细对应一个商品 |
| 用户 | N:N | 角色 | 用户和角色是多对多关系 |

#### 聚合根识别

- **订单聚合根**：Order
  - 包含：OrderItem, OrderStatusLog, OrderPayment
  - 边界：订单相关操作都通过 Order 进行

- **用户聚合根**：User
  - 包含：UserProfile, UserAddress
  - 边界：用户信息操作都通过 User 进行
```

### 3. 业务规则提取

**核心任务**：从代码中提取业务规则

#### 规则来源

- Service 层的校验逻辑
- Model 层的访问器/修改器
- 枚举类的状态定义
- 数据库的约束条件

#### 分析输出格式

```markdown
### 业务规则清单

#### 数据约束规则

| 规则编号 | 规则描述 | 实现位置 |
|----------|----------|----------|
| R001 | 订单号必须唯一 | orders.order_no UNIQUE |
| R002 | 订单金额必须大于 0 | OrderService::createOrder |
| R003 | 用户手机号格式校验 | UserRequest 验证规则 |

#### 业务流程规则

| 规则编号 | 规则描述 | 触发条件 |
|----------|----------|----------|
| R101 | 订单创建后自动生成订单号 | 创建订单时 |
| R102 | 支付成功后更新订单状态 | 支付回调时 |
| R103 | 发货后自动记录物流单号 | 发货操作时 |

#### 状态约束规则

| 规则编号 | 规则描述 | 相关状态 |
|----------|----------|----------|
| R201 | 只有待支付订单可以取消 | pending → cancelled |
| R202 | 已发货订单不能退款 | shipped 状态时 |
| R203 | 已完成订单 7 天后自动评价 | completed 状态后 |
```

### 4. 状态流转分析

**核心任务**：分析业务状态的流转规则

#### 分析要点

- 状态枚举值
- 状态流转路径
- 状态变更触发条件
- 状态变更的业务影响

#### 分析输出格式

```markdown
### 状态流转分析

#### 订单状态流转

| 当前状态 | 可流转到 | 触发条件 | 业务操作 |
|----------|----------|----------|----------|
| 待支付(pending) | 已支付(paid) | 支付成功 | 扣减库存 |
| 待支付(pending) | 已取消(cancelled) | 用户取消/超时 | 释放库存 |
| 已支付(paid) | 已发货(shipped) | 商家发货 | 记录物流 |
| 已发货(shipped) | 已完成(completed) | 用户确认收货 | 结算货款 |
| 已支付(paid) | 退款中(refunding) | 用户申请退款 | 冻结货款 |

#### 状态流转图（文字描述）

```
pending (待支付)
    ├──→ paid (已支付) ──→ shipped (已发货) ──→ completed (已完成)
    │         │
    │         └──→ refunding (退款中) ──→ refunded (已退款)
    │
    └──→ cancelled (已取消)
```

### 5. 字段业务含义分析

**核心任务**：翻译技术字段为业务含义

#### 分析输出格式

```markdown
### 核心字段业务含义

#### orders 表（订单）

| 字段名 | 类型 | 业务含义 | 取值说明 |
|--------|------|----------|----------|
| order_no | varchar | 订单编号 | 系统自动生成，格式：年月日+序号 |
| status | tinyint | 订单状态 | 1=待支付，2=已支付，3=已发货... |
| total_amount | decimal | 订单总金额 | 商品金额+运费-优惠 |
| discount_amount | decimal | 优惠金额 | 优惠券抵扣金额 |
| shipping_fee | decimal | 运费 | 根据运费模板计算 |
| paid_at | datetime | 支付时间 | 支付成功时记录 |
| shipped_at | datetime | 发货时间 | 发货操作时记录 |

#### 重要计算逻辑

| 计算项 | 计算公式 | 业务说明 |
|--------|----------|----------|
| 订单总金额 | 商品金额 + 运费 - 优惠金额 | 用户实际支付金额 |
| 商品金额 | Σ(单价 × 数量) | 所有明细的商品金额合计 |
```

### 6. 变更影响分析（如适用）

**核心任务**：评估需求变更的影响范围

#### 分析维度

- **数据层面**：需要修改哪些表/字段
- **逻辑层面**：需要修改哪些业务逻辑
- **接口层面**：需要修改哪些接口
- **关联影响**：会影响哪些关联功能

#### 分析输出格式

```markdown
### 变更影响分析

#### 变更需求

> 在订单中增加运费险功能

#### 影响范围评估

##### 1. 数据层面

| 影响项 | 变更内容 | 影响程度 |
|--------|----------|----------|
| orders 表 | 新增 shipping_insurance 字段 | 低 |
| orders 表 | 新增 insurance_amount 字段 | 低 |

##### 2. 业务逻辑层面

| 影响项 | 变更内容 | 影响程度 |
|--------|----------|----------|
| 创建订单 | 增加运费险选择逻辑 | 中 |
| 金额计算 | 总金额需包含运费险 | 中 |
| 退款逻辑 | 运费险是否退还 | 中 |

##### 3. 接口层面

| 影响项 | 变更内容 | 影响程度 |
|--------|----------|----------|
| 创建订单接口 | 新增运费险参数 | 低 |
| 订单详情接口 | 返回运费险信息 | 低 |

##### 4. 关联功能影响

- 订单导出：需要导出运费险信息
- 财务报表：需要统计运费险金额
- 退款流程：需要处理运费险退款
```

## 重要约束

- **使用业务语言** - 所有输出使用产品经理能理解的语言
- **明确数据维度** - 清晰说明每个实体的维度类型
- **关联场景说明** - 说明数据在哪些业务场景中使用
- **标注不确定项** - 对于不确定的分析结果要标注

## 与用户的交互

分析阶段的交互示例：

**分析过程中**：

- "我正在分析数据实体的维度..."
- "发现订单有 3 个关联的明细实体..."
- "正在提取业务规则..."

**分析完成**：

- "分析完成，订单模块包含 1 个主实体、3 个明细实体..."
- "我整理了 15 条业务规则和完整的状态流转图..."
- "接下来我会生成产品经理可以直接使用的文档..."

## 完成标志

- 数据维度分析完成
- 实体关系梳理清晰
- 业务规则提取完整
- 状态流转图绘制完成
- 字段含义翻译完成
- 变更影响评估完成（如适用）
- 准备进入文档阶段
